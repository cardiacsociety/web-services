<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Upload</title>
    <link rel="stylesheet" href="main.css">
</head>
<body>

<div id="uploading">UPLOADING <img src="loading.svg"></div>

<input type="file" id="file-input" disabled>
<input type="hidden" id="key-path" value="/cpd/12345/">
<input type="hidden" id="bucket" value="upload-test-1734">
<input type="submit" id="upload-attachment" value="Upload" onclick="upload()">

<p id="status">Select a file and click upload</p>
<p id="link"></p>

<script>

    var jwt = "";
    getToken("member@mappcpd.com", "demoMember1");

    // To upload we need a token from the API using the standard credentials
    function getToken(login, pass) {

        const xhr = new XMLHttpRequest();
        const body = `{"login": "${login}", "password": "${pass}"}`;

        xhr.open("POST", "http://localhost:5000/v1/auth/member")
        xhr.setRequestHeader("Content-Type", "application/json");

        xhr.onreadystatechange = () => {
            if(xhr.readyState === 4) {
                if(xhr.status === 200) {
                    const response = JSON.parse(xhr.responseText);
                    jwt = response.data.token;
                    document.getElementById("file-input").disabled = false;
                } else {
                    alert('Could not get auth token');
                }
            }
        };

        xhr.send(body);
    }

    function upload() {

        document.getElementById("uploading").style.display = "flex";

        const files = document.getElementById('file-input').files;
        const file = files[0];
        if(file == null){
            return alert('No file selected.');
        }
        getSignedRequest(file, jwt);
    }


    function getSignedRequest(file, jwt){
        const xhr = new XMLHttpRequest();

        // Call to the API to get a signed request URL
        console.log("getSignedRequest() has:")
        console.log("file: " + file);
        console.log("jwt: " + jwt);

        // These come from the form and are already known from the parent entity...
        var key = document.getElementById("key-path").value + file.name;
        var bucket = document.getElementById("bucket").value;

        var upload = {
            fileName: file.name,
            fileType: file.type,
            key: key,
            bucket: bucket
        };

        console.log(upload);


        xhr.open('GET', `http://localhost:5000/v1/g/attachments/putrequest?filename=${upload.fileName}&filetype=${upload.fileType}&key=${upload.key}&bucket=${upload.bucket}`);
        xhr.setRequestHeader("Authorization", "Bearer " + jwt);

        xhr.onreadystatechange = () => {
            if(xhr.readyState === 4) {
                if(xhr.status === 200) {
                    const response = JSON.parse(xhr.responseText);
                    uploadFile(file, response.data.signedRequest, response.data.key);
                } else {
                    alert('Could not get signed URL.');
                }
            }
        };

        xhr.send();
    }

    // the 'key' is passed into path and is the full path to the file relative to the bucket root
    function uploadFile(file, signedRequest, path){

        console.log("Uploading " + file.name)
        console.log("Signed Request: " + signedRequest)
        console.log("Path " + path)


        const xhr = new XMLHttpRequest();
        xhr.open('PUT', signedRequest);
        xhr.onreadystatechange = () => {
            if(xhr.readyState === 4){
                document.getElementById("uploading").style.display = "none";
                if(xhr.status === 200){
                    document.getElementById('link').innerHTML = path;
                    document.getElementById('status').innerHTML = "Done";
                }
                else{
                    document.getElementById('status').innerHTML = "Error!";
                }
            }
        };
        xhr.send(file);
    }
</script>
</body>
</html>